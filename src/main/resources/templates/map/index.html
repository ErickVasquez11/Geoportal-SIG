<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Geoportal Centros de Asistencia Médica</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Incluyendo hojas de estilo locales y externas -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Cobertura Médica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" href="/css/main.css" th:href="@{/webjars/leaflet/1.0.3/leaflet.css}" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script type="text/javascript" src="webjars/jquery/3.2.0/jquery.min.js"
        th:src="@{/webjars/jquery/3.2.0/jquery.min.js}"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript" src="/webjars/leaflet/1.0.3/leaflet.js"
        th:src="@{/webjars/leaflet/1.0.3/leaflet.js}"></script>
    <link rel="stylesheet" type="text/css" href="webjars/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
        th:href="@{/webjars/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        df-messenger {
            --df-messenger-bot-message: #374151;
            --df-messenger-button-titlebar-color: #374151;
            --df-messenger-chat-background-color: #fafafa;
            --df-messenger-font-color: white;
            --df-messenger-send-icon: #374151;
            --df-messenger-user-message: #479b3d;
            --df-messenger-chat-bubble-background: #479b3d;
            --df-messenger-chat-bubble-icon-color: #479b3d;
        }

        .custom-dropdown-menu {
            max-height: 200px;
            overflow-y: auto;
        }

        .back {
            background-color: #2b6cb0;
        }

        .back:hover {
            background-color: #3182ce;
            border-color: #3a8230;
        }

        .medical-marker {
            border: none !important;
            background: transparent !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .chat-animation {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toggle-switch {
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background-color: #0ea5e9;
        }

        .toggle-switch.active .toggle-circle {
            transform: translateX(20px);
        }

        .coverage-legend {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
    <link rel="icon" href="/images/alfiler.png" type="image/png" />
</head>

<!-- Header -->
<header class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center space-x-3">
                <div class="bg-gradient-to-r from-sky-500 to-blue-600 p-2 rounded-lg">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Geoportal Médico</h1>
                    <p class="text-sm text-gray-600">Análisis Espacial de Cobertura</p>
                </div>
            </div>

            <nav class="flex space-x-1">
                <button onclick="switchTab('coverage')" id="tab-coverage"
                    class="tab-button flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-sky-100 text-sky-700 shadow-sm">
                    <i class="fas fa-shield-alt"></i>
                    <span class="hidden sm:inline">Análisis de Cobertura</span>
                </button>
                <button onclick="switchTab('centers')" id="tab-centers"
                    class="tab-button flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="hidden sm:inline">Centros Médicos</span>
                </button>
                <button onclick="switchTab('routing')" id="tab-routing"
                    class="tab-button flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                    <i class="fas fa-route"></i>
                    <span class="hidden sm:inline">Navegación</span>
                </button>
                <button onclick="switchTab('population')" id="tab-population"
                    class="tab-button flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                    <i class="fas fa-users"></i>
                    <span class="hidden sm:inline">Datos Poblacionales</span>
                </button>
                <button onclick="window.location.href='/login'" id="tab-login"
                    class="tab-button flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                    <i class="fas fa-sign-in-alt"></i>
                    <span class="hidden sm:inline">Iniciar Sesión</span>
                </button>
            </nav>
        </div>
    </div>
</header>

<body class="bg-gray-100">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Analysis Panel -->
                <div id="panel-coverage" class="panel bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-sky-600 mr-2"></i>
                        Análisis Espacial
                    </h3>

                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-map-marker-alt text-gray-500"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Áreas de Cobertura</p>
                                    <p class="text-xs text-gray-500">Muestra el radio de cobertura médica</p>
                                </div>
                            </div>
                            <div class="toggle-switch w-11 h-6 bg-gray-200 rounded-full cursor-pointer"
                                onclick="toggleCoverage()">
                                <div
                                    class="toggle-circle w-4 h-4 bg-white rounded-full shadow-md transform transition-transform translate-x-1 mt-1">
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-exclamation-triangle text-gray-500"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Zonas de Riesgo</p>
                                    <p class="text-xs text-gray-500">Áreas con mayor tasa de emergencias</p>
                                </div>
                            </div>
                            <div class="toggle-switch w-11 h-6 bg-gray-200 rounded-full cursor-pointer"
                                onclick="toggleRiskZones()">
                                <div
                                    class="toggle-circle w-4 h-4 bg-white rounded-full shadow-md transform transition-transform translate-x-1 mt-1">
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-users text-gray-500"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Densidad Poblacional</p>
                                    <p class="text-xs text-gray-500">Superposición de datos demográficos</p>
                                </div>
                            </div>
                            <div class="toggle-switch w-11 h-6 bg-gray-200 rounded-full cursor-pointer"
                                onclick="togglePopulation()">
                                <div
                                    class="toggle-circle w-4 h-4 bg-white rounded-full shadow-md transform transition-transform translate-x-1 mt-1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Estadísticas de Cobertura</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <p class="text-xs text-green-600 font-medium">Área Cubierta</p>
                                <p class="text-lg font-bold text-green-800">78%</p>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg">
                                <p class="text-xs text-red-600 font-medium">Sin Cobertura</p>
                                <p class="text-lg font-bold text-red-800">22%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Centers Panel -->
                <div id="panel-centers" class="panel bg-white rounded-lg shadow-lg p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Centros Médicos</h3>
                    <div class="space-y-3" id="centers-list">
                        <!-- Centers will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Routing Panel -->
                <div id="panel-routing" class="panel bg-white rounded-lg shadow-lg p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-route text-sky-600 mr-2"></i>
                        Navegación y Rutas
                    </h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
                            <div class="flex space-x-2">
                                <input type="text" id="origin-input" placeholder="Ingrese dirección de origen"
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                                <button onclick="getCurrentLocation()"
                                    class="px-3 py-2 bg-sky-100 text-sky-700 rounded-lg hover:bg-sky-200 transition-colors"
                                    title="Usar mi ubicación">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
                            <select id="destination-select"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-transparent">
                                <option value="">Seleccionar centro médico</option>
                                <option value="Hospital Nacional Rosales">Hospital Nacional Rosales</option>
                                <option value="Clínica San Jacinto">Clínica San Jacinto</option>
                                <option value="Hospital Bloom">Hospital Bloom</option>
                                <option value="Clínica Miramonte">Clínica Miramonte</option>
                                <option value="Unidad de Salud Soyapango">Unidad de Salud Soyapango</option>
                            </select>
                        </div>

                        <button onclick="calculateRoute()"
                            class="w-full bg-sky-600 text-white py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-route"></i>
                            <span>Calcular Ruta</span>
                        </button>
                    </div>

                    <div id="route-info" class="mt-6 p-4 bg-sky-50 rounded-lg hidden">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Información de la Ruta</h4>
                        <div class="flex items-center space-x-4 mb-3">
                            <div class="flex items-center space-x-1 text-sm text-gray-600">
                                <i class="fas fa-route"></i>
                                <span id="route-distance">3.2 km</span>
                            </div>
                            <div class="flex items-center space-x-1 text-sm text-gray-600">
                                <i class="fas fa-clock"></i>
                                <span id="route-duration">8 min en auto</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900 mb-2">Instrucciones:</p>
                            <ol id="route-instructions" class="text-xs text-gray-600 space-y-1">
                                <!-- Instructions will be populated by JavaScript -->
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Population Panel -->
                <div id="panel-population" class="panel bg-white rounded-lg shadow-lg p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-users text-sky-600 mr-2"></i>
                        Datos Poblacionales
                    </h3>

                    <div class="space-y-4" id="population-data">
                        <!-- Population data will be populated by JavaScript -->
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Resumen Regional</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-sky-600">2,475</p>
                                <p class="text-xs text-gray-600">Densidad Promedio</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-red-600">11.5</p>
                                <p class="text-xs text-gray-600">Emergencias Promedio</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Map -->
            <div class="lg:col-span-2 h-96 lg:h-[650px] relative">
                <div id="mapid"></div>

                <!-- Map Legend -->
                <div class="absolute top-4 left-4 z-[1000] coverage-legend rounded-lg shadow-lg p-3">
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">Hospitales</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">Clínicas</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">Centros de Salud</span>
                        </div>
                    </div>
                </div>
                <!--
                <div class="flex flex-col items-center md:flex-row md:justify-center md:items-center">
                    <h1 class="font-bold text-center text-xl mx-auto md:ml-4">
                        Clínicas Comunales
                    </h1>
                    <d class="flex-end">
                        <label for="municipioFilter" class="block text-sm font-medium text-gray-700">Filtrar por
                            Municipio:</label>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                style="background-color: white; color: black">
                                Seleccionar Municipios
                            </button>
                            <div class="dropdown-menu custom-dropdown-menu" aria-labelledby="dropdownMenuButton"
                                style="background-color: white; color: black">
                                <th:block th:each="municipio, index : ${municipios}">
                                    <a class="dropdown-item">
                                        <input type="checkbox" id="municipio_${index}" th:value="${municipio}"
                                            th:data-value="${municipio}" />
                                        <label th:for="'municipio' + ${index}" th:text="${municipio}">Municipio</label>
                                    </a>
                                </th:block>
                                <div class="text-center">
                                    <button id="updateDataButton" class="btn btn-primary mt-2">
                                        Actualizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    -->
        </div>
        <!--
            <div class="table-container" style="overflow-x: auto">
                <table class="min-w-full overflow-x-auto divide-y divide-gray-200">
                <thead class="bg-gray-700 text-white">
                    <tr>
                    <th scope="col" class="px-6 py-3 text-left font-medium uppercase tracking-wider">
                        Nombre
                    </th>
                    <th scope="col" class="px-6 py-3 text-left font-medium uppercase tracking-wider">
                        Dirección
                    </th>
                    <th scope="col" class="px-6 py-3 text-left font-medium uppercase tracking-wider">
                        Municipio
                    </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <th:block th:each="centro : ${centros}">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                        <a th:href="@{/map/informacion(id=${centro.id})}"
                            class="text-blue-500 hover:text-blue-700" th:text="${centro.nombre}"></a>
                        </td>
                        <td th:text="${centro.direccion}" class="px-6 py-4 whitespace-nowrap"></td>
                        <td th:text="${centro.municipio}" class="px-6 py-4 whitespace-nowrap"></td>
                    </tr>
                    </th:block>
                </tbody>
                </table>
                <div class="pagination-container">
                <ul class="pagination-menu">
                    <li th:if="${currentPage > 0}">
                    <a th:href="@{/map/index(page=${currentPage - 1}, size=${size})}"
                        class="pagination-link">Anterior</a>
                    </li>
                    <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:href="@{/map/index(page=${i}, size=${size})}" th:text="${i + 1}"
                        class="pagination-link"></a>
                    </li>
                    <li th:if="${currentPage <totalPages - 1}">
                    <a th:href="@{/map/index(page=${currentPage + 1}, size=${size})}"
                        class="pagination-link">Siguiente</a>
                    </li>
                </ul>
                </div>
            </div>
        -->
    </div>
    </div>
    <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>

¿
    <df-messenger intent="WELCOME" chat-title="GeoAgente" chat-icon="https://i.ibb.co/fvbZ8ZP/logo2.png"
        agent-id="918c7b00-fc13-47e3-84c6-41fd9dff493e" language-code="es">
    </df-messenger>

    <!--  Este script agrega los pins de las clinicas y un pin con la ubicacion del usuario asimismo busca una clinica que posiblemente sea la mas cercana del usuario -->
    <script th:inline="javascript">

        // Mapa con icono personalizado
        var customIcon = L.icon({
            iconUrl: '/images/alfiler2.png',
            iconSize: [42, 42],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        var serverContext = [[@{/}]];
        var model_map = [[${ model.map }]];
        var clinicasComunales = [[${ centrosMapa }]];
        var mymap = L.map('mapid').setView([13.693399179677684, -89.21802884256014], 13);
        new L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(mymap);
        mymap.on('zoomend', updateLeafletMap, mymap);
        mymap.on('moveend', updateLeafletMap, mymap);

        clinicasComunales.forEach(element => L.marker([element.coorY, element.coorX], { icon: customIcon }).addTo(mymap).bindPopup(`<h5>${element.nombre}</h5>`));



        function updateLeafletMap(ev) {
            var map = this;
            var form_data = new FormData();
            form_data.append('zoom', map.getZoom());
            form_data.append('baseLayer', model_map.baseLayer);
            form_data.append('centerX', map.getCenter().lng);
            form_data.append('centerY', map.getCenter().lat);
            form_data.append('id', model_map.id);

            $.ajax({
                url: serverContext + 'map/update',
                data: form_data,
                processData: false,
                contentType: false,
                type: 'POST',
                success: function (data) {
                    console.log(data);
                }
            });
        }

        var userMarker;
        var userCircle;

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; // Radio de la Tierra en metros
            var φ1 = lat1 * Math.PI / 180; // φ, λ en radianes
            var φ2 = lat2 * Math.PI / 180;
            var Δφ = (lat2 - lat1) * Math.PI / 180;
            var Δλ = (lon2 - lon1) * Math.PI / 180;

            var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            var d = R * c; // en metros
            return d;
        }

        function findNearestClinic(userLat, userLon, clinics) {
            if (clinics.length === 0) {
                return null;
            }

            let nearestClinic = clinics[0];
            let minDistance = calculateDistance(userLat, userLon, clinics[0].coorY, clinics[0].coorX);

            clinics.forEach(clinic => {
                let distance = calculateDistance(userLat, userLon, clinic.coorY, clinic.coorX);
                if (distance < minDistance) {
                    nearestClinic = clinic;
                    minDistance = distance;
                }
            });

            return nearestClinic;
        }

        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            if (userMarker) {
                mymap.removeLayer(userMarker);
                mymap.removeLayer(userCircle);
            }

            userMarker = L.marker(e.latlng).addTo(mymap)
                .bindPopup("Usted se encuentra dentro de  " + radius + " metros de este punto").openPopup();


            var nearestClinic = findNearestClinic(e.latlng.lat, e.latlng.lng, clinicasComunales);

            if (nearestClinic) {
                L.marker([nearestClinic.coorY, nearestClinic.coorX], { icon: customIcon }).addTo(mymap)
                    .bindPopup(`<h5>${nearestClinic.nombre}</h5><p>Dirección: ${nearestClinic.direccion}</p><p>Distancia: ${(Math.round(calculateDistance(e.latlng.lat, e.latlng.lng, nearestClinic.coorY, nearestClinic.coorX))) / 1000} kilometros</p>`)
                    .openPopup();
            }
        }

        function onLocationError(e) {
            alert(e.message);
        }

        mymap.on('locationfound', onLocationFound);
        mymap.on('locationerror', onLocationError);
        mymap.locate({ setView: true, maxZoom: 16 });

        mymap.on('click', function () {
            mymap.eachLayer(function (layer) {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    mymap.removeLayer(layer);
                }
                if (layer instanceof L.Circle && layer !== userCircle) {
                    mymap.removeLayer(layer);
                }
            });

            clinicasComunales.forEach(clinica => {
                L.marker([clinica.coorY, clinica.coorX], { icon: customIcon }).addTo(mymap).bindPopup(`<h5>${clinica.nombre}</h5>`);
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const menuButton = document.querySelector(".mobile-menu-button");
            const mobileMenu = document.querySelector(".mobile-menu");
            menuButton.addEventListener("click", function () {
                mobileMenu.classList.toggle("hidden");
            });
        });
    </script>
    <!--  Este script agrega funcionalidad para interactuar con las filas de la tabla y el mapa -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            const tableRows = document.querySelectorAll("tbody tr");

            tableRows.forEach((row) => {
                row.addEventListener("click", function () {
                    const clinicaId = row.querySelector("td:first-child").innerText;

                    mymap.eachLayer(function (layer) {
                        if (layer instanceof L.Marker && layer !== userMarker) {
                            mymap.removeLayer(layer);
                        }
                        if (layer instanceof L.Circle && layer !== userCircle) {
                            mymap.removeLayer(layer);
                        }
                    });

                    const clinica = clinicasComunales.find(
                        (clinica) => clinica.id === parseInt(clinicaId)
                    );
                    if (clinica) {
                        L.marker([clinica.coorY, clinica.coorX], { icon: customIcon })
                            .addTo(mymap)
                            .bindPopup(`<h5>${clinica.nombre}</h5>`)
                            .openPopup();
                    }
                });
            });

            mymap.on("click", function () {
                mymap.eachLayer(function (layer) {
                    if (layer instanceof L.Marker && layer !== userMarker) {
                        mymap.removeLayer(layer);
                    }
                    if (layer instanceof L.Circle && layer !== userCircle) {
                        mymap.removeLayer(layer);
                    }
                });

                clinicasComunales.forEach((clinica) => {
                    L.marker([clinica.coorY, clinica.coorX], { icon: customIcon })
                        .addTo(mymap)
                        .bindPopup(`<h5>${clinica.nombre}</h5>`);
                });
            });
        });
    </script>
    <!-- Comentario: Este script maneja el filtrado de las clínicas según los municipios seleccionados. -->
    <script>
        $(document).ready(function () {
            $(".dropdown-menu label").click(function () {
                var $checkbox = $(this).find(":checkbox");
                $checkbox.prop("checked", !$checkbox.prop("checked"));

                var selectedItems = $(".dropdown-menu input:checked")
                    .map(function () {
                        return $(this).attr("data-value");
                    })
                    .get();

                var buttonText = "Seleccionar municipios";
                if (selectedItems.length > 0) {
                    buttonText = selectedItems.join(", ");
                }

                $(this).closest(".dropdown").find(".btn").html(buttonText);

                return false;
            });
        });

        function asignarEventosDeClicAFilas() {
            const tableRows = document.querySelectorAll("tbody tr");
            tableRows.forEach((row) => {
                row.addEventListener("click", function () {
                    const clinicaId = row.querySelector("td:first-child").innerText;

                    mymap.eachLayer(function (layer) {
                        if (layer instanceof L.Marker && layer !== userMarker) {
                            mymap.removeLayer(layer);
                        }
                        if (layer instanceof L.Circle && layer !== userCircle) {
                            mymap.removeLayer(layer);
                        }
                    });

                    const clinica = clinicasComunales.find(
                        (clinica) => clinica.id === parseInt(clinicaId)
                    );
                    if (clinica) {
                        L.marker([clinica.coorY, clinica.coorX], { icon: customIcon })
                            .addTo(mymap)
                            .bindPopup(`<h5>${clinica.nombre}</h5>`)
                            .openPopup();
                    }
                });
            });
        }

        $("#updateDataButton").click(function () {
            var selectedMunicipios = [];
            $('input[type="checkbox"]:checked').each(function () {
                var municipio = $(this).val();
                selectedMunicipios.push(municipio);
            });
            console.log("Municipios seleccionados:", selectedMunicipios);
            var filteredClinicas;
            if (selectedMunicipios.length === 0) {
                filteredClinicas = clinicasComunales;
            } else {
                filteredClinicas = clinicasComunales.filter(function (clinica) {
                    return selectedMunicipios.includes(clinica.municipio);
                });
            }
            console.log("Clínicas filtradas:", filteredClinicas);
            $("tbody").empty();
            filteredClinicas.forEach(function (clinica) {
                $("tbody").append(`
                <tr id="clinica-${clinica.id}">
                    <td  class="px-6 py-4 whitespace-nowrap">${clinica.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${clinica.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${clinica.direccion}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${clinica.municipio}</td>
                </tr>
            `);
            });

            $(".list-container").empty();
            filteredClinicas.forEach(function (clinica) {
                $(".list-container").append(
                    `<li>${clinica.nombre}, ${clinica.direccion}, ${clinica.municipio}</li>`
                );
            });

            mymap.eachLayer(function (layer) {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    mymap.removeLayer(layer);
                }
                if (layer instanceof L.Circle && layer !== userCircle) {
                    mymap.removeLayer(layer);
                }
            });

            filteredClinicas.forEach(function (clinica) {
                L.marker([clinica.coorY, clinica.coorX], { icon: customIcon })
                    .addTo(mymap)
                    .bindPopup(`<h5>${clinica.nombre}</h5>`);
            });
            asignarEventosDeClicAFilas();
        });
    </script>
</body>

</html>